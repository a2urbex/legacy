{% block content %}
<style>
.message_date {
    font-size: 10px;
    opacity: .6;
    margin-top: 5px;
}

#chat{  
    overflow-y: scroll;
    padding: 10px;
}
.message{
    display: block;
    max-width: 70%;
    margin-bottom: 10px;
}
.message_content{
    background-color:#737373;
    font-size: 14px;
    width:fit-content;
    padding: 5px 8px;
    color : white;
    border-radius: 10px;
    margin-bottom: 0;
}
.name{
    font-size: 11px;
    color : #5A5A5A;
    margin-bottom: 0.2rem;
    margin-top: 0.2rem;
}

.ROLE_SERVER > .message_content {
    width: 100%!important;
    max-width: 100%!important;
    text-align: center;
    border-radius: 0;
}
.message.ROLE_SERVER {
    max-width: 100%!important;
}

.ROLE_ADMIN > .name {
    color: #ffd000;
    font-weight: 400;
    display: flex;
}
.ROLE_ADMIN > .name .shield {
    margin-left: 3px;
}


.user_current {
    margin-left: auto;
}
.user_current > .name {
    width: fit-content;
    margin-left: auto;
}

.user_current > .message_date {
  text-align:right;
}

.user_current > .message_content{
    margin-left: auto;
    background-color:#5DA0F1;
}

.user_current.ROLE_ADMIN > .name  {
    flex-direction: row-reverse;
}
.user_current.ROLE_ADMIN > .name .shield {
    margin-left: 0;
    margin-right: 3px;
}


.messenger_title{
    margin: 0;
    padding: 10px;
    color:#a2a2a2;
    border-bottom: #525252 1px solid;
}

.messenger_close {
    transition: all .5s;
}
.messenger_close:hover, .messenger_close:active {
    color: white;
}

.message_send {
    background-color: #303030;
    text-align: center;
    border: #525252 1px solid;
    padding: 5px;
    margin-left: -1px;
    border-bottom-left-radius: 5px;
    border-bottom-right-radius: 5px;
    display: flex;
}

input#message {
    flex-grow: 1;
    background-color: #737373;
    border: none;
    border-radius: 40px;
    color: white;
    font-size: 13px;
    padding: 4px;
    padding-left: 8px;
    height: 30px;
}

input:focus{
    outline: none;
}
.message_btn:focus{
     outline: none;
}
.message_btn{
    background-color: transparent;
    color: #737373;
    border: none;
    color: white;
    position: relative;
    width: 30px;
    height: 30px;
    margin-left: 5px;
}

.message_btn i {
    position: relative;
    z-index: 2;
    left: -1px;
}
.message_btn::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 30px;
    height: 30px;
    z-index: 0;
    border-radius: 50%;
    transform: scale(0);
    transition: all .5s;
    background-color: rgba(0,0,0,.3);
}
.message_btn:hover::after, .message_btn:active::after {
    transform: scale(1);
}


#chat::-webkit-scrollbar {
    width: 10px;
}

/* Track */
#chat::-webkit-scrollbar-track {
    background: #303030;
}

/* Handle */
#chat::-webkit-scrollbar-thumb {
    background: #404040;
    margin: 1px;
    border-radius: 10px;
}

/* Handle on hover */
#chat::-webkit-scrollbar-thumb:hover {
    background: #999;
}


</style>

    <div id="chat">
        </div>
        <div class="form-group message_send">
        <input type="text" id="message">
        <button type="button" class="message_btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>


<script type="text/javascript">
    const socket = new WebSocket("{{ websocket }}");
    const currentId = {{ user_id }}

    socket.addEventListener("open", function() {
        console.log("Connected to General Chat")
        fetch('/chat-get')
            .then(response => response.json())
            .then(data => {
                renderChatHistory(data)
            });
    });

    socket.addEventListener("message", function(e) {
        try {
            const data = JSON.parse(e.data)
            // NOTIFICATION
            const myDiv = document.getElementById('messenger_dot')
            myDiv.classList.add('messenger_dot_notification')
            // NOTIFICATION
            addMessage(data)
            $('#chat').scrollTop($('#chat')[0].scrollHeight)
        } catch(e) {}
    });

    document.getElementById("message").addEventListener("keydown", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("sendBtn").click()
        }
    })

    document.getElementById("sendBtn").addEventListener("click", function(event) {
        event.preventDefault()
        const messageInput = document.getElementById("message")
        const messageValue = messageInput.value.trim()
        
        if (messageValue === '') return
        
        fetch('/chat-add', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: messageValue
        })
        .then(response => response.json())
        .then(data => {
            if(data.error) {
                if(data.error === 'reload') window.location.reload()
                else alert(date.error)
            } else {
                addMessage(data)
                $('#chat').scrollTop($('#chat')[0].scrollHeight)
                messageInput.value = ''
                socket.send(JSON.stringify(data))
            }
        })
    })

    function addMessage(data) {
        const messageHTML = renderRow(data)
        document.getElementById("chat").innerHTML += messageHTML
    }

    function renderChatHistory(chatHistory) {
        const chatHTML = chatHistory.map(item => {
            return renderRow(item)
        }).join("")
        $('#chat').scrollTop($('#chat')[0].scrollHeight)
        document.getElementById("chat").innerHTML = chatHTML
        $('#chat').scrollTop($('#chat')[0].scrollHeight)
    }

    function renderRow(item) {
        const timestamp = Date.parse(item.datetime)
        const date = new Date(timestamp)
        const dateFormatted = date.toLocaleString('fr-FR', { year:"numeric", month:"numeric", day:"numeric", hour: '2-digit', minute:'2-digit'})

        const sender = item.sender ? item.sender : {
            id: 0,
            firstname: 'a2urbex',
            roles: ['ROLE_SERVER']
        }

        return "<div class='message " + sender.roles.join(' ') + (sender.id === currentId ? ' user_current' : '') +"'>"
            +"<p class='name'>"
            +"<span>" + sender.firstname + "#" + sender.id + "</span>"
            + (sender.roles.includes('ROLE_ADMIN') ? '<span class="shield"><i class="fa-solid fa-shield-halved"></i></span>' : '')
            +"</p>"
            +"<p class='message_content'> " + item.message + "</p>"
            +"<p class='message_date'> " + dateFormatted + "</p>"
            +"</div>"
        ;
    }

    $('#chat').scrollTop($('#chat')[0].scrollHeight)
</script>
{% endblock %}